name: Deploy to GitHub Pages with Leaderboard Config

on:
  push:
    branches: [main, cleanup]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create config.js with secrets
        run: |
          cat > config.js << 'EOF'
          /**
           * Leaderboard Configuration
           * Auto-generated by GitHub Actions
           */
          export const LEADERBOARD_CONFIG = {
              gistId: '${{ secrets.GIST_ID }}',
              githubToken: '${{ secrets.GIST_TOKEN }}',
              storageKey: 'wikiGameLeaderboard'
          };
          EOF
          echo "âœ… config.js created"
      
      - name: Verify configuration
        run: |
          if [ -f config.js ]; then
            echo "âœ… config.js exists"
          else
            echo "âš ï¸ config.js not created, using localStorage fallback"
          fi
        
      - name: Setup Pages
        uses: actions/configure-pages@v5
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Leaderboard Status" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ secrets.GIST_ID }}" ] && [ -n "${{ secrets.GIST_TOKEN }}" ]; then
            echo "âœ… Global leaderboard: **ENABLED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Global leaderboard: **NOT CONFIGURED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Using localStorage fallback. To enable global leaderboard:" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to Repository Settings â†’ Secrets and variables â†’ Actions" >> $GITHUB_STEP_SUMMARY
            echo "2. Add secret: GIST_ID" >> $GITHUB_STEP_SUMMARY
            echo "3. Add secret: GIST_TOKEN" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ® Play Now" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
